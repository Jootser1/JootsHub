# üõ†Ô∏è √âtape 1 : Build
FROM node:20-alpine AS builder

WORKDIR /joots-backend

# Installer les d√©pendances
COPY package*.json ./
RUN npm ci

# Copier uniquement les dossiers utiles
COPY tsconfig*.json ./
COPY src ./src
COPY prisma ./prisma

# G√©n√©rer Prisma Client
RUN npx prisma generate

# Compiler le projet
RUN npm run build

# üîß √âtape 2 : Cr√©ation de l'image de prod minimale
FROM node:20-alpine AS runner

WORKDIR /joots-backend

# Copier le build, les d√©pendances et le fichier package.json
COPY --from=builder /joots-backend/dist ./dist
COPY --from=builder /joots-backend/node_modules ./node_modules
COPY --from=builder /joots-backend/package.json ./package.json
COPY --from=builder /joots-backend/prisma ./prisma

ENV NODE_ENV=production
EXPOSE 4000

CMD ["sh", "-c", "npx prisma migrate deploy && [ \"$SEED_DB\" = \"true\" ] && npx prisma db seed; node dist/src/main.js"]

