# üõ†Ô∏è √âtape 1 : Build
FROM node:20-alpine AS builder

# Cr√©er la structure de dossiers √† la racine
WORKDIR /

# √âtape 1 ‚Äî Copier et compiler les types partag√©s
COPY ./packages ./packages

# Build des types partag√©s
WORKDIR /packages/types
RUN npm install --verbose && npm run build && ls -la dist/

# √âtape 2 ‚Äî Aller dans le dossier backend et installer les d√©pendances
WORKDIR /joots-backend

# Copier les fichiers de package en premier pour optimiser le cache Docker
COPY joots-backend/package*.json ./
RUN npm ci

# √âtape 3 : Copier le sch√©ma et g√©n√©rer le client Prisma
COPY ./joots-backend/prisma ./prisma
RUN npx prisma generate --schema=./prisma/schema.prisma

# Copier les fichiers de configuration et source
COPY joots-backend/tsconfig*.json ./
COPY joots-backend/src ./src

# Compiler le projet (maintenant les types sont disponibles via ../packages/types/dist/*)
RUN npm run build

# üîß √âtape 2 : Cr√©ation de l'image de prod minimale
FROM node:20-alpine AS runner

# Cr√©er la m√™me structure que dans le builder (√† la racine)
WORKDIR /

# Copier les types partag√©s compil√©s (maintenir la structure)
COPY --from=builder /packages ./packages

# Aller dans le dossier backend
WORKDIR /joots-backend

# Copier le build, les d√©pendances et les fichiers n√©cessaires
COPY --from=builder /joots-backend/dist ./dist
COPY --from=builder /joots-backend/node_modules ./node_modules
COPY --from=builder /joots-backend/package.json ./package.json
COPY --from=builder /joots-backend/prisma ./prisma


# Commande de d√©marrage avec gestion d'erreur am√©lior√©e
CMD ["sh", "-c", "npx prisma migrate deploy && ([ \"$SEED_DB\" = \"true\" ] && npx prisma db seed || true) && node dist/main.js"]

